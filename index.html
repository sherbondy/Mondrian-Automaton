<!DOCTYPE HTML>
<html lang="en-us">
<head>
	<meta charset="utf-8">
	<link href="http://fonts.googleapis.com/css?family=Arvo&subset=latin" 
	    rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="style.css" type="text/css">
	<link rel="icon" type="img/png" href="favicon.png">
	
	<script src="processing-1.0.0.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js" 
        type="text/javascript"></script>
    
    <script type="text/javascript">
		// Array Remove - By John Resig (MIT Licensed)
		Array.prototype.remove = function(from, to) {
		  var rest = this.slice((to || from) + 1 || this.length);
		  this.length = from < 0 ? this.length + from : from;
		  return this.push.apply(this, rest);
		};
		
		var hash = "";
		var options = ["boogie","color_a","composition", "new_york_creater"];
		var clicks = 0;
		
		if (window.openDatabase) {
			db = openDatabase('gallery', '1.0', 'Mondrian Automaton gallery', 10 * 1024 * 1024);
			db.transaction(function(tx) {
				tx.executeSql('CREATE TABLE IF NOT EXISTS images (id unique, title TEXT, src TEXT, clicks INT)');
			});
		} else {
			console.log("Web Databases not supported.");
		}
		
		function hash_change() {
			if (location.hash != hash) {
				hash = location.hash;
				$("header a").removeClass("current");
				$("#main div").not(location.hash).fadeOut();
				$(location.hash).fadeIn();
				$(location.hash).trigger("generate");
				$("a[href='"+hash+"']").addClass("current");
			}
		}
		
		location.hash = location.hash ? location.hash : "#content";
		setInterval("hash_change()", 100);
    
        $(function() {
			$("#gallery").bind("generate", function(e) {
				$(this).children().remove();
				db.transaction(function(tx) {
					tx.executeSql('SELECT * FROM images', [], function(tx, results) {
						if (results.rows && results.rows.length) {
							$("#gallery").append("<ul/>");
							for(i=results.rows.length-1; i>=0; i--) {
								var li = '<li><span class="clicks">'+results.rows.item(i).clicks+' clicks</span>'
										+'<h3>'+unescape(results.rows.item(i).title)+'</h3>'
										+'<img src="'+unescape(results.rows.item(i).src)+'"></li>';
								$("#gallery ul").append(li);
							}
						} else {
							$("#gallery").append("<h2>Nothing in the gallery yet.</h2>");
						}
					});
				});
			});
			
			var hletters = $("h1 a").text().split("");
			var colors = ["red", "yellow", "blue", "grey", "black"];
			
			function colorify_title() {
				$("h1 a").text("");
				for (i = 0; i<hletters.length; i++) {
					var color = colors[Math.floor(Math.random()*colors.length)];
					$("h1 a").append('<span class="'+color+'">'+hletters[i]+'</span>');
				}
			}
			
			colorify_title();
			
			// $("canvas").css("-webkit-transform", "rotate(45deg) scale(0.6)");
			
			// ranges for width height tweaking [320,480], [240,480], [480,480]
			$(document).data("width", 480);
			$(document).data("height", 480);
			
			$("canvas").each(function() {
				var i = Math.floor(Math.random()*options.length);
				var selection = options[i];
				var my_id = $(this).attr("id");
				
				$.get(selection+".pde", function(code) {
					$("#"+my_id).data("selection", selection);
					var canvas = document.getElementById(my_id);
					new Processing(canvas, code);
				});
				options.remove(i);
			});
			
            $("#i").click(function() {
                $("#info").toggle();
				$(this).toggleClass("current");
                return false;
            });
            $("#x").click(function() {
                $("#info").hide();
				$("#i").removeClass("current");
                return false;
            });
        
            $("canvas").click(function() {
                clicks += 1;
                return false;
            });
            
            $("#images a").click(function() {
                var source = document.getElementById($(this).attr("href").slice(1)).toDataURL();
                $("#image_src").attr("src", source);
                $("#upload").show();
                return false;
            });

			$("h1 a").click(colorify_title);

			function close_upload() {
				$("#image_name").val("").removeClass("error");
				$("#errors").text("").hide();
                $("#upload").hide();
			}
            
            $("#cancel").click(function() {
				close_upload();
            });

			$("#upload form").submit(function() {
				$("#image_name").removeClass("error");
				$("#errors").text("").hide();
				
				var the_title = escape($("#image_name").val().replace(/^\s+|\s+$/g, ''));
				var the_src = escape($("#image_src").attr("src"));
				
				if (the_title.length) {
					if (the_title.length < 64) {
						var index = 0;
						db.transaction(function(tx) {
							tx.executeSql('SELECT * FROM images', [], function(tx, results) {
								if (results.rows && results.rows.length) {
									index = results.rows.length;
								}
							});
						});
						
						console.log(index);
						
						db.transaction(function(tx) {
							tx.executeSql('INSERT INTO images (id, title, src, clicks) '
										 +'values (?, ?, ?, ?)',
										[index, the_title, the_src, clicks]);
						});
					
						close_upload();
						location.hash = "#gallery";
					} else {
						$("#errors").text("Title too long, please shorten.").show();
						$("#image_name").addClass("error");
					}
				} else {
					$("#errors").text("No title entered.").show();
					$("#image_name").addClass("error");
				}
								
				return false;
			});
        });
    </script>
    
	<title>Mondrian</title>
</head>
<body>
    <div id="upload">
        <form>
            <h2>Add to the Gallery</h2>
			<p id="errors"></p>
            <input type="text" name="image_name" id="image_name" placeholder="Give it a title.">
            <img id="image_src" src="#">
            <input type="submit" id="submit" value="Submit">
            <input type="button" id="cancel" value="Cancel">
        </form>
    </div>
    
    <header>
        <h1><a href="#content">Mondrian Automaton</a></h1>
        <a href="#info" id="i">Info</a>
        <a href="#gallery" id="gal">Gallery</a>
    </header>
    
    <details id="info">
        <p>An experiment in websites as art for 
            <a href="http://courses.media.mit.edu/2010fall/mas110/">MAS.110</a>.
        </p>
        <p>
            Mondrian-style images are generated with a little 
            help from <a href="http://processingjs.org/">processing.js</a>.
        </p>
        
        <p>
            Icons from <a href="http://glyphish.com/">Glyphish</a>.
            The typefaces are Distill and Arvo.
        </p>
        <p>
            Created by <a href="http://www.tooepic.com">Ethan Sherbondy</a>.
        </p>
        <p>
            Play with the source on <a href="https://github.com/sherbondy/Mondrian-Automaton">GitHub</a>.
        </p>
        <a id="x" href="#">X</a>
    </details>
    
	<div id="main">
	    <div id="content">
	        <h2>Choose the image you prefer, and we&rsquo;ll hone in on your tastes.</h2>
            
	        <ol id="images">
	            <li>
	                <canvas id="c1"></canvas>
	                <a href="#c1">Add to gallery</a>
	            </li>
        
	            <li>
	                <canvas id="c2"></canvas>
	                <a href="#c2">Add to gallery</a>
	            </li>
            
	            <li>
	                <canvas id="c3"></canvas>
	                <a href="#c3">Add to gallery</a>
	            </li>
        
	            <li>
	                <canvas id="c4"></canvas>
	                <a href="#c4">Add to gallery</a>
	            </li>
	        </ol>
	    </div>

		<div id="gallery">
		
		</div>
	</div>
</body>
</html>